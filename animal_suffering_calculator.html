<!DOCTYPE html>
<meta charset="utf-8">
<head>
<style>

.rectangle {
	fill: steelblue;
	/*border: 5px solid black;*/
}
.rectangle:hover {
	fill: orange;
}

.axis {
  font: 14px sans-serif;
}

body {
  font: 14px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
</style>
</head>
<body>
<div id="drop" align=center>Expected direct suffering per </div>

<div align=center>Species weighting: <select id="weight">

  <option value="Neuron count, log">Neuron count, log</option>
  <option value="Neuron count, linear">Neuron count, linear</option>
  <option value="Brain mass, log">Brain mass, log</option>
  <option value="Brain mass, linear">Brain mass, linear</option>
  <option value="Synapse max, log">Synapse max, log</option>
  <option value="Synapse max, linear">Synapse max, linear</option>
	<option value="Equal">Equal</option>
</select></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var unit = 'Kilogram';
var weighting = 'Neuron count, log';

var margin = {top: 80, right: 180, bottom: 80, left: 180},
	width = 960 - margin.left - margin.right,
	height = 500 - margin.top - margin.bottom;

var svg = d3.select("body").append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.tsv("why.tsv", function(error, data){
	// console.log(data);
	// filter
	var data = data.filter(function(d){return true;});
	// Get every column value
	var elements = Object.keys(data[0])
		.filter(function(d){
			return d != "Product";
		});
	// console.log(elements);
	var selection = elements[0];

	var y = d3.scale.linear()
			.domain([0, d3.max(data, function(d){
				val = d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting];
				return +val;
			})])
			.range([height, 0]);

	var x = d3.scale.ordinal()
			.domain(data.map(function(d){ return d.Product;}))
			.rangeBands([0, width]);


	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom");

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left");

	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis)
		.selectAll("text")
		.style("font-size", "14px")
		.style("text-anchor", "center")
		.attr("dx", "-0em")
		.attr("dy", "+1em")
		.attr("transform", "rotate(0)" );


	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis);




		//
		//
		// instantiate
		//
		//
	svg.selectAll("rectangle")
		.data(data)
		.enter()
		.append("rect")
		.attr("class","rectangle")
		.attr("width", width/data.length)
		.attr("height", function(d){
			var val = d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting];

			return height - y(+val);
		})
		.attr("x", function(d, i){
			return (width / data.length) * i ;
		})
		.attr("y", function(d){

						var val = d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting];

			return y(+val);
		})
		.append("title")
		.text(function(d){
			return d.Product + " : " + d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting];
		});






		//
		//
		// change unit
		//
		//
	var selector = d3.select("#drop")
		.append("select")
		.attr("id","dropdown")
		.on("change", function(d){
			selection = document.getElementById("dropdown");
			unit = selection.value;
			y.domain([0, d3.max(data, function(d){
				// console.log(selection.value);
				val = d[selection.value] * d['Norwood-Lusk Elasticity'] * d[weighting];
				// console.log(val,d[selection.value],d['Norwood-Lusk Elasticity'], weighting, d[weighting]);
				return +val;})]);

			yAxis.scale(y);

			d3.selectAll(".rectangle")
				.transition()
				.attr("height", function(d){
					val = d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting];

			return height - y(+val);

				})
				.attr("x", function(d, i){
					return (width / data.length) * i ;
				})
				.attr("y", function(d){
					return y(+(d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting]));
				})
				.ease("linear")
				.select("title")
				.text(function(d){
					return d.Product + " : " + (d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting]);
				});

			d3.selectAll("g.y.axis")
				.transition()
				.call(yAxis);

		 });




		//
		//
		// change weighting
		//
		//
			var weight_selector = d3.select("#weight")
		.on("change", function(d){
			// console.log("you just picked a weight");
			selection = document.getElementById("weight");
			// console.log(selection.value);
			weighting = selection.value;
			y.domain([0, d3.max(data, function(d){
				// console.log(selection.value);
				val = d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting];
				return +val;})]);

			yAxis.scale(y);

			d3.selectAll(".rectangle")
				.transition()
				.attr("height", function(d){
			// 		console.log(weighting);
			// console.log(d[weighting]);
			// console.log(d);
					return height - y(+(d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting]));
				})
				.attr("x", function(d, i){
					return (width / data.length) * i ;
				})
				.attr("y", function(d){
					return y(+(d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting]));
				})
				.ease("linear")
				.select("title")
				.text(function(d){
					return d.Product + " : " + (d[unit] * d['Norwood-Lusk Elasticity'] * d[weighting]);
				});

			d3.selectAll("g.y.axis")
				.transition()
				.call(yAxis);

		 });




	selector.selectAll("option")
	  .data(["Kilogram", "Gram of Protein", "Calorie"])
	  .enter().append("option")
	  .attr("value", function(d){
		// console.log(d);
		return d;
	  })
	  .text(function(d){
		return d;
	  })


});

</script>
</body>